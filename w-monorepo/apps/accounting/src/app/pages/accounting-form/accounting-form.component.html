<div class="accounting-form">
  <h2>{{ isEditMode ? '编辑' : '新增' }}开台记录</h2>
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- 开始时间 -->
    <label>
      开始时间：
      <input
        type="datetime-local"
        formControlName="startDateTime"
        (focus)="openDatePicker($event)"
      />
      <div
        class="error"
        *ngIf="
          form.get('startDateTime')?.touched &&
          form.get('startDateTime')?.hasError('required')
        "
      >
        开始时间为必填项
      </div>
    </label>

    <!-- 结束时间 -->
    <label>
      结束时间：
      <input
        type="datetime-local"
        formControlName="endDateTime"
        (focus)="openDatePicker($event)"
      />
      <div
        class="error"
        *ngIf="
          form.get('endDateTime')?.touched &&
          form.get('endDateTime')?.hasError('required')
        "
      >
        结束时间为必填项
      </div>
    </label>

    <!-- 时长 -->
    <label>
      时长（小时）：
      <input type="number" [value]="form.get('duration')?.value" readonly />
    </label>

    <!-- 包房选择 -->
    <label>
      包房选择：
      <select formControlName="roomId">
        <option [ngValue]="null">无（不选包房）</option>
        <option *ngFor="let room of roomList" [ngValue]="room.id">
          {{ room.roomNumber }}
        </option>
      </select>
      <small
        class="selected-room-tip"
        *ngIf="roomIdFromQuery && selectedRoomNumber"
      >
        已自动选择包房：{{ selectedRoomNumber }}
      </small>
    </label>

    <!-- 游戏机类型 -->
    <label>
      游戏机类型：
      <select formControlName="consoleType">
        <option value="" disabled>请选择游戏机类型</option>
        <option *ngFor="let console of consoleOptions" [value]="console">
          {{ console }}
        </option>
      </select>
      <div
        class="error"
        *ngIf="
          form.get('consoleType')?.touched &&
          form.get('consoleType')?.hasError('required')
        "
      >
        游戏机类型为必选项
      </div>
    </label>

    <!-- 游戏选择 -->
    <label>
      游戏名：
      <input
        type="text"
        [formControl]="searchControl"
        (focus)="showSuggestions = true"
        (blur)="onBlur()"
        placeholder="输入关键词搜索游戏"
      />
    </label>

    <div class="game-select">
      <ul
        *ngIf="showSuggestions && filteredSuggestions.length > 0"
        class="suggestions"
      >
        <li
          *ngFor="let suggestion of filteredSuggestions"
          (mousedown)="selectGame(suggestion)"
        >
          {{ suggestion.name }}
        </li>
      </ul>

      <!-- 已选游戏 -->
      <div class="selected-games">
        <span *ngFor="let game of selectedGames" class="chip">
          {{ game }}
          <button type="button" (click)="removeGame(game)">×</button>
        </span>
      </div>
    </div>

    <!-- 客户类型 -->
    <label>
      客户类型：
      <select formControlName="customerType">
        <option value="" disabled>请选择客户类型</option>
        <option *ngFor="let type of customerTypes" [value]="type">
          {{ type }}
        </option>
      </select>
      <div
        class="error"
        *ngIf="
          form.get('customerType')?.touched &&
          form.get('customerType')?.hasError('required')
        "
      >
        客户类型为必选项
      </div>
    </label>

    <!-- 是否会员 -->
    <div
      *ngIf="form.get('customerType')?.value === '会员'"
      class="member-search-wrapper"
    >
      <label>
        会员搜索：
        <input
          type="text"
          formControlName="memberSearchInput"
          (input)="onMemberInput()"
          placeholder="按姓名或手机号搜索"
          autocomplete="off"
        />
      </label>

      <!-- 搜索结果列表 -->
      <ul *ngIf="memberSearchResults.length > 0" class="suggestions">
        <li *ngFor="let m of memberSearchResults" (click)="selectMember(m)">
          <strong>{{ m.name }}</strong> - {{ m.phone }}
        </li>
      </ul>

      <!-- 已选会员显示 -->
      <div *ngIf="selectedMemberId" class="selected-member">
        已选择会员：
        <span>{{ selectedMemberName }}</span>
        <button type="button" (click)="clearSelectedMember()">×</button>
      </div>
    </div>

    <!-- 是否回头客 -->
    <label *ngIf="form.get('customerType')?.value !== '会员'">
      是否回头客：
      <input type="checkbox" formControlName="isReturning" />
    </label>

    <!-- 实收金额 -->
    <label>
      实收金额：
      <input type="number" formControlName="actualAmount" />
      <div class="error" *ngIf="form.get('actualAmount')?.touched">
        <span *ngIf="form.get('actualAmount')?.hasError('required')">
          实收金额为必填项
        </span>
        <span *ngIf="form.get('actualAmount')?.hasError('min')">
          实收金额不能小于 0
        </span>
      </div>
    </label>

    <!-- 平台 -->
    <label *ngIf="form.get('customerType')?.value !== '会员'">
      平台：
      <select formControlName="platform">
        <option value="" disabled>请选择平台</option>
        <option *ngFor="let p of platforms" [value]="p">{{ p }}</option>
      </select>
      <div
        class="error"
        *ngIf="
          form.get('platform')?.touched &&
          form.get('platform')?.hasError('required')
        "
      >
        平台为必选项
      </div>
    </label>

    <!-- 备注 -->
    <label *ngIf="form.get('customerType')?.value !== '会员'">
      备注（可选）：
      <textarea
        formControlName="remark"
        rows="5"
        placeholder="请输入备注内容"
      ></textarea>
    </label>

    <!-- 联系方式 -->
    <label *ngIf="form.get('customerType')?.value !== '会员'">
      联系方式类型（可选）：
      <select formControlName="contactType">
        <option *ngFor="let c of contactTypes" [value]="c">{{ c }}</option>
      </select>
    </label>

    <label *ngIf="form.get('customerType')?.value !== '会员'">
      联系方式（可选）：
      <input formControlName="contactValue" />
    </label>

    <!-- 提交/取消按钮 -->
    <div class="actions">
      <button type="submit">{{ isEditMode ? '保存修改' : '提交' }}</button>
      <button type="button" (click)="router.navigate(['/accounting-card'])">
        取消
      </button>
    </div>
  </form>
</div>
