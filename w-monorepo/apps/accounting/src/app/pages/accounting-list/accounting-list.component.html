<div class="accounting-list">
  <div class="top-bar">
    <button class="add-button" [routerLink]="['/accounting/new']">
      ➕ 新增记录
    </button>

    <!-- ✅ 新增导出按钮 -->
    <button class="export-button" (click)="downloadTxt()">
      📥 导出账单统计
    </button>

    <!-- ✅ 导出指定时间段 -->
    <button class="export-button" (click)="openExportRangeModal()">
      📤 导出指定账单
    </button>

    <!-- 搜索组合 -->
    <div class="search-bar">
      <select [(ngModel)]="searchField">
        <option value="gameNames">游戏名</option>
        <option value="customerType">客户类型</option>
        <option value="platform">平台</option>
        <option value="remark">备注</option>
      </select>
      <input [(ngModel)]="searchKeyword" placeholder="请输入搜索关键字" />
      <button (click)="search()">🔍 搜索</button>
    </div>
  </div>

  <table class="record-table">
    <thead>
      <tr>
        <th>单号</th>
        <th>时间段</th>
        <th>时长</th>
        <th>机型</th>
        <th>游戏名</th>
        <th>客户类型</th>
        <th>回头客</th>
        <th>实收金额</th>
        <th>备注</th>
        <th>平台</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let record of pagedRecords">
        <td [title]="record.id">{{ record.id }}</td>
        <td [title]="formatTimeRange(record.startDateTime, record.endDateTime)">
          {{ formatTimeRange(record.startDateTime, record.endDateTime) }}
        </td>
        <td [title]="record.duration">{{ record.duration }}</td>
        <td [title]="record.consoleType">{{ record.consoleType }}</td>
        <td [title]="record.gameNames.join('; ')">
          {{ record.gameNames.join('; ') }}
        </td>
        <td [title]="record.customerType">{{ record.customerType }}</td>
        <td [title]="record.isReturning ? '是' : '否'">
          {{ record.isReturning ? '是' : '否' }}
        </td>
        <td [title]="record.actualAmount">{{ record.actualAmount }}</td>
        <td [title]="record.remark">{{ record.remark }}</td>
        <td [title]="record.platform">{{ record.platform }}</td>
        <td>
          <button [routerLink]="['/accounting/edit', record.id]">编辑</button>
          <button (click)="delete(record.id)">删除</button>
          <button (click)="openReminderModal(record)">提醒</button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- 分页控件 + 统计 -->
  <div class="pagination">
    <button (click)="prevPage()" [disabled]="currentPage === 1">上一页</button>
    <span>第 {{ currentPage }} 页 / 共 {{ totalPages }} 页</span>
    <button (click)="nextPage()" [disabled]="currentPage === totalPages">
      下一页
    </button>
    <span class="total-count">共 {{ records.length }} 条数据</span>
  </div>
</div>

<div class="reminder-modal" *ngIf="showReminder">
  <div class="reminder-wrapper">
    <div class="reminder-card" #reminderCard>
      <h3>尊敬的玩家！</h3>
      <p>游戏开始时间：{{ formatDate(reminderRecord?.startDateTime!) }}</p>
      <p>游玩时长：{{ reminderRecord?.duration }} 小时</p>
      <p>
        结束时间：<span class="end-date-time">{{
          formatDate(reminderRecord?.endDateTime!)
        }}</span>
      </p>
      <p class="greeting">酷乐乐游戏，祝您游戏愉快！</p>
    </div>

    <div class="buttons">
      <button (click)="closeReminderModal()">关闭</button>
      <button (click)="exportReminderAsImage()">生成图片</button>
    </div>
  </div>
</div>

<!-- ✅ 弹窗：导出时间段选择 -->
<div class="reminder-modal" *ngIf="showExportRangeModal">
  <div class="reminder-wrapper">
    <div class="reminder-card">
      <h3>导出账单（时间段）</h3>

      <p>
        开始时间：
        <input type="datetime-local" [(ngModel)]="exportStartDateTime" />
      </p>
      <p>
        结束时间：
        <input type="datetime-local" [(ngModel)]="exportEndDateTime" />
      </p>

      <div class="buttons">
        <button (click)="closeExportRangeModal()">取消</button>
        <button (click)="downloadRangeTxt()">下载 TXT</button>
      </div>
    </div>
  </div>
</div>
