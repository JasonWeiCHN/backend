<h2>上传游戏配置文件</h2>

<div class="form-container">
  <label class="form-line">
    <span class="form-label">选择文件：</span>
    <input type="file" (change)="onFileSelected($event)" />
  </label>

  <ng-container *ngIf="data">
    <!-- tab header -->
    <div class="tab-header">
      <button
        [class.active]="activeTab === 'editGame'"
        (click)="activeTab = 'editGame'"
      >
        游戏编辑
      </button>
      <button
        [class.active]="activeTab === 'category'"
        (click)="activeTab = 'category'"
      >
        分类管理
      </button>
      <button
        [class.active]="activeTab === 'allGames'"
        (click)="viewAllGames()"
      >
        全部游戏
      </button>
    </div>

    <div *ngIf="activeTab === 'category'">
      <h3>分类</h3>
      <div class="category-list">
        <div
          *ngFor="let category of data.categories; let i = index"
          class="category-item"
        >
          <input [(ngModel)]="data.categories[i]" />
          <span class="delete-btn" (click)="removeCategory(i)">×</span>
        </div>
        <button (click)="addCategory()">添加分类</button>
      </div>
    </div>

    <div *ngIf="activeTab === 'editGame'">
      <div class="game-buttons">
        <button style="margin-right: 12px" (click)="addGame()">
          添加新游戏
        </button>
        <button (click)="viewAllGames()">
          查看全部游戏（共{{ data.games.length }}个）
        </button>
      </div>

      <div class="search-game">
        <input
          [(ngModel)]="gameSearch"
          (keydown.enter)="searchGame()"
          placeholder="搜索游戏（支持关键字）"
        />
        <button (click)="searchGame()">搜索</button>
      </div>
      <!-- ✅ 搜索结果下拉列表 -->
      <ul *ngIf="searchResults.length > 1" class="search-results">
        <li
          *ngFor="let g of searchResults"
          (click)="selectGame(g)"
          class="result-item"
        >
          {{ g.name }}
        </li>
      </ul>

      <div *ngIf="selectedGame" class="game-card">
        <label class="form-line">
          <span class="form-label">游戏名：</span>
          <input [(ngModel)]="selectedGame.name" />
        </label>

        <label class="form-line">
          <span class="form-label">封面图：</span>
          <input [(ngModel)]="selectedGame.image" />
        </label>

        <div class="form-line">
          <span class="form-label">视频地址：</span>
          <div class="form-block">
            <div
              *ngFor="let vid of selectedGame.videos; let vi = index"
              class="swiper-item"
            >
              <input [(ngModel)]="selectedGame.videos[vi]" />
              <button class="btn-delete" (click)="removeVideo(vi)">删除</button>
            </div>
            <button (click)="addVideo()">添加视频</button>
          </div>
        </div>

        <label class="form-line">
          <span class="form-label">关键字：</span>
          <input [(ngModel)]="selectedGame.searchKeywords" />
        </label>

        <label class="form-line">
          <span class="form-label">跳转链接：</span>
          <input [(ngModel)]="selectedGame.path" />
        </label>

        <label class="form-line">
          <span class="form-label">发布日期：</span>
          <input type="date" [(ngModel)]="selectedGame.releaseDate" />
        </label>

        <label class="form-line">
          <span class="form-label">描述：</span>
          <textarea [(ngModel)]="selectedGame.description" rows="3"></textarea>
        </label>

        <div class="form-line">
          <span class="form-label">详情图：</span>
          <div class="form-block">
            <div
              *ngFor="let img of selectedGame.imagesForDetail; let ii = index"
              class="swiper-item"
            >
              <input [(ngModel)]="selectedGame.imagesForDetail[ii]" />
              <button
                class="btn-delete"
                (click)="removeImage(selectedGame, ii)"
              >
                删除
              </button>
            </div>
            <button (click)="addImage(selectedGame)">添加详情图</button>
          </div>
        </div>

        <div class="form-line">
          <span class="form-label">标签：</span>
          <div class="form-block">
            <div
              *ngFor="let tag of selectedGame.tags; let ti = index"
              class="swiper-item"
            >
              <input [(ngModel)]="selectedGame.tags[ti]" />
              <button class="btn-delete" (click)="removeTag(selectedGame, ti)">
                删除
              </button>
            </div>
            <button (click)="addTag(selectedGame)">添加标签</button>
          </div>
        </div>

        <h4>类型</h4>
        <div
          *ngFor="let genre of selectedGame.genres; let gi = index"
          class="genre-item"
        >
          <label class="form-line">
            <span class="form-label">ID：</span>
            <input [(ngModel)]="genre.id" />
          </label>
          <label class="form-line">
            <span class="form-label">名称：</span>
            <input [(ngModel)]="genre.name" />
          </label>
          <label class="form-line">
            <span class="form-label">描述：</span>
            <input [(ngModel)]="genre.description" />
          </label>
          <button class="btn-delete" (click)="removeGenre(selectedGame, gi)">
            删除类型
          </button>
        </div>
        <button (click)="addGenre(selectedGame)">添加类型</button>

        <h4>攻略</h4>
        <div
          *ngFor="let guide of selectedGame.guides; let gui = index"
          class="genre-item"
        >
          <label class="form-line">
            <span class="form-label">标题：</span>
            <input [(ngModel)]="guide.title" />
          </label>
          <label class="form-line">
            <span class="form-label">描述：</span>
            <input [(ngModel)]="guide.description" />
          </label>
          <label class="form-line">
            <span class="form-label">作者：</span>
            <input [(ngModel)]="guide.author" />
          </label>
          <label class="form-line">
            <span class="form-label">链接：</span>
            <input [(ngModel)]="guide.sourceUrl" />
          </label>
          <button class="btn-delete" (click)="removeGuide(selectedGame, gui)">
            删除攻略
          </button>
        </div>
        <button (click)="addGuide(selectedGame)">添加攻略</button>

        <hr />

        <div style="margin-top: 12px">
          <button class="btn-delete" (click)="deleteSelectedGame()">
            删除此游戏
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'allGames'">
      <div class="search-game">
        <input
          [(ngModel)]="allGamesFilter"
          (input)="filterAllGames()"
          placeholder="过滤全部游戏（输入关键字）"
        />
      </div>
      <ul class="all-games-list">
        <li
          *ngFor="let g of filteredAllGames"
          (click)="selectFromAll(g)"
          class="all-game-item"
        >
          {{ g.name }}
        </li>
      </ul>
    </div>

    <hr />
    <button (click)="download()">下载为 games.js</button>
  </ng-container>
</div>
